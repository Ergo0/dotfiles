var FederatedLogin=new function(){var e=this,r={};FederatedLoginService.call(e),e._ajax=function(e){"undefined"!=typeof base_url&&0!==e.url.indexOf("http")&&(e.url=base_url+e.url),LPServer.ajax(e)},e.login=function(r){r=fix_username(r),e.getPassword(r,function(e,t){LP_do_login(r,e,void 0,void 0,void 0,void 0,void 0,void 0,void 0,t)},lpshowError)};var t=function(r,t){if(r.keypair){var a=(new DOMParser).parseFromString(atob(t),"application/xml").querySelector('Attribute[Name="LastPassKeyPart"]').childNodes[0].textContent;r.valid=!!e._decryptK1WithPrivateKey(atob(a),r.keypair.privateKey),r.submitted=!0,r.valid||e._handleError(r.error,new Error("K1 not valid!"))}},a=function(e){try{if(e&&e.formData&&e.formData.SAMLResponse&&1===e.formData.SAMLResponse.length)return e.formData.SAMLResponse[0];if(e&&e.raw){var r=e.raw.reduce(function(e,r){return e+String.fromCharCode.apply(null,new Uint8Array(r.bytes))},"");if(r.length>0){var t=(a={},r.split("&").forEach(function(e){var r=e.split("=");2===r.length&&(a[r[0]]=decodeURIComponent(r[1]))}),a);if(t.SAMLResponse)return t.SAMLResponse}}}catch(e){console.log(e)}var a;return null};e.getPassword=function(n,i,o){n=fix_username(n),LPPlatform.getCurrentTabDetails(function(l){e._initiate(n,function(d,s){var u={valid:!1,idp:d,keypair:s,submitted:!1,error:o};LPPlatform.openTab({extension:!0,url:d.IdentityProviderURL+"/auth/saml2/"+d.IdentityProviderGUID,loadHandler:function(f){u.cleanup=LPPlatform.onBeforeNavigate(function(r,c){var v=/\/auth\/saml2\/success\/(.*)$/.exec(r);if(v&&2===v.length)return u.valid||!s?e._getAuthInfo(n,v[1],function(r){e._assemblePassword(n,s,r,function(e){i(e,r.authSessionId)},o)},o):e._handleError(o,new Error("K1 not valid!")),u.submitted=!0,LPPlatform.closeTab(f.tabDetails),LPPlatform.activateTab(l),!1;if(s&&!u.valid&&0===r.indexOf(d.IdentityProviderURL)){var p=a(c);if(p)return t(u,p),u.valid}},f.tabDetails),r[f.tabDetails.tabID]=u},closeHandler:function(){u.submitted||e._handleError(o,new Error("Federated login tab closed!"))}})})})},e.validateK1Encryption=function(e,a,n){var i=!0,o=r[n.tabID];o&&o.keypair&&(t(o,e),i=o.valid),a&&a(i)},LPPlatform.onTabClosed(function(e){r[e]&&(r[e].cleanup(),delete r[e])})};
//# sourceMappingURL=sourcemaps/extension-federated-login.js.map
